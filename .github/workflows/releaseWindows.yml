name: "Win/x86 "

env:
  BUILD_TYPE: Release

on:
  workflow_run:
    workflows: ["Versioner "]
    types:
      - completed

jobs:
  build-windows:
    runs-on: windows-latest
        
    steps:
    - uses: actions/checkout@v3
      with:
        fetch-depth: 0
        ref: main

    - name: Configure CMake
      run: cmake -B ${{github.workspace}}\Binaries\Windows-x86\

    - name: Build
      run: cmake --build ${{github.workspace}}\Binaries\Windows-x86 --target ALL_BUILD --config ${{env.BUILD_TYPE}}

    - name: Delete old binary
      continue-on-error: true
      run: del "${{github.workspace}}\Binaries\Windows-x86\byteman.exe"

    - name: Put new binary
      run: move "${{github.workspace}}\Binaries\Windows-x86\Release\byteman.exe" "${{github.workspace}}\Binaries\Windows-x86\"

    - name: Commit binary
      shell: pwsh
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add ${{github.workspace}}\Binaries\Windows-x86\byteman.exe
        git commit -m "Binaries"
        $ErrorActionPreference = "Stop" 
        do{
          try{
            git push
            $pushed = $true
          }
          catch{
            try{
              git pull
            }
            catch{
              Start-Sleep -s 1
            }
          } 
        }until($pushed)
